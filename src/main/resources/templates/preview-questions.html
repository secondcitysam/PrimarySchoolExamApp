<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Question Preview</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/teacher-navbar :: navbar}"></div>

<div class="page-content">
    <div class="card" style="max-width:900px;">

        <h2>Question Preview</h2>

        <div id="viewer">

            <!-- Question Index -->
            <div id="qIndex"
                 style="
                   margin-bottom:12px;
                   font-weight:600;
                   color:#374151;
                 ">
            </div>

            <!-- Question Text -->
            <div id="qText"
                 style="
                   margin-bottom:10px;
                   font-size:16px;
                   font-weight:500;
                 ">
            </div>

            <!-- Marks -->
            <div id="qMarks"
                 style="
                   margin-bottom:16px;
                   font-size:14px;
                   color:#64748b;
                 ">
            </div>

            <!-- Options -->
            <ul id="options"
                style="
                  list-style:none;
                  padding-left:0;
                  margin:0;
                ">
            </ul>

            <!-- Navigation -->
            <div style="
                display:flex;
                justify-content:space-between;
                margin-top:22px;
            ">
                <button type="button" onclick="prev()">‚¨Ö Prev</button>
                <button type="button" onclick="next()">Next ‚û°</button>
            </div>

            <!-- Edit -->
            <div style="margin-top:20px; text-align:center;">
                <button type="button" onclick="edit()">
                    ‚úèÔ∏è Edit This Question
                </button>
            </div>

            <!-- Make Live -->
            <div id="liveBox"
                 style="
                   margin-top:30px;
                   padding-top:20px;
                   border-top:1px solid #e5e7eb;
                   display:none;
                   text-align:center;
                 ">

                <button type="button"
                        onclick="makeLive()"
                        style="background:#16a34a;">
                    üöÄ Make Test LIVE
                </button>

                <p id="err" class="error"></p>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    const questions = /*[[${questions}]]*/ [];
    const testId = [[${testId}]];
    const locked = [[${locked}]];

    let index = 0;

    function render() {
        if (!questions.length) {
            document.getElementById("qText").innerText =
                "No questions added yet";
            return;
        }

        const q = questions[index];

        document.getElementById("qIndex").innerText =
            "Question " + (index + 1) + " of " + questions.length;

        document.getElementById("qText").innerText = q.text;
        document.getElementById("qMarks").innerText =
            "Marks: " + q.marks;

        const optionsEl = document.getElementById("options");
        optionsEl.innerHTML = "";

        q.options.forEach(o => {
            const li = document.createElement("li");
            li.style.padding = "8px";
            li.style.marginBottom = "6px";
            li.style.borderRadius = "6px";
            li.style.background =
                o.correct ? "#dcfce7" : "#f8fafc";

            li.innerText = o.text + (o.correct ? " ‚úî" : "");
            optionsEl.appendChild(li);
        });

        // show LIVE button only on last question & not locked
        const liveBox = document.getElementById("liveBox");
        if (!locked && index === questions.length - 1) {
            liveBox.style.display = "block";
        } else {
            liveBox.style.display = "none";
        }
    }

    function prev() {
        if (index > 0) {
            index--;
            render();
        }
    }

    function next() {
        if (index < questions.length - 1) {
            index++;
            render();
        }
    }

    function edit() {
        window.location.href =
            "/teacher/tests/" + testId + "/questions";
    }

    async function makeLive() {
        const res = await fetch(
            "/api/teacher/tests/" + testId + "/live",
            {
                method: "POST",
                credentials: "include"
            }
        );

        if (res.ok) {
            location.reload();
        } else {
            document.getElementById("err").innerText =
                await res.text();
        }
    }

    render();
</script>

</body>
</html>
